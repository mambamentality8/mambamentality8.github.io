# 媒资管理系统集成

### 学习页面查询课程计划

#### 需求分析

​	到目前为止，我们已可以编辑课程计划信息并上传课程视频，下一步我们要实现在线学习页面动态读取章节对应的视频并进行播放。在线学习页面所需要的信息有两类：一类是课程计划信息、一类是课程学习信息（视频地址、学习进度等），如下图：

![1526291618627](file:///E:/%E4%BC%A0%E6%99%BA%E5%B7%A5%E4%BD%9C/%E5%A4%87%E8%AF%BE%E8%B5%84%E6%96%99/JavaEE%E5%9C%A8%E7%BA%BF%E5%B0%B1%E4%B8%9A%E7%8F%AD%E8%AF%BE%E7%A8%8B%E8%B5%84%E6%96%99/7.%E9%98%B6%E6%AE%B5%E4%B8%83-%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/01-HTML%E7%89%88%E6%9C%AC%E8%AE%B2%E4%B9%89(%E8%AF%B7%E4%BD%BF%E7%94%A8HTML%E7%89%88%E6%9C%AC%E8%AE%B2%E4%B9%89%E5%AD%A6%E4%B9%A0)/HTML%E7%89%88%E6%9C%AC/day15%20%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E9%9B%86%E6%88%90/images/1526291618627.png)

在线学习集成媒资管理的需求如下：

1、在线学习页面显示课程计划

2、点击课程计划播放该课程计划对应的视频

 

本章节实现学习页面动态显示课程计划，进入不同课程的学习页面右侧动态显示当前课程的课程计划。

#### Api

课程计划信息从哪里获取？

目前课程计划信息在课程管理数据库和ES索引库中存在，考虑性能要求，课程发布后对课程的查询统一从ES索引库中查询。

前端通过请求搜索服务获取课程信息，需要单独在搜索服务中定义课程信息查询接口。

本接口接收课程id，查询课程所有信息返回给前端。

```
    @ApiOperation("根据课程id查询课程信息")
    public Map<String,CoursePub> getall(String id);
```

 返回的课程信息为json结构：key为课程id，value为课程内容。

#### Controller

```
    @Override
    @GetMapping("/getall/{id}")
    public Map<String, CoursePub> getall(@PathVariable("id") String id) {
        return esCourseService.getall(id);
    }
```

#### service

在搜索服务中增加查询课程信息接口的service

```
    //使用ES的客户端向ES请求查询索引信息
    public Map<String, CoursePub> getall(String id) {
        //定义一个搜索请求对象
        SearchRequest searchRequest = new SearchRequest(index);
        //指定type
        searchRequest.types(type);

        //定义SearchSourceBuilder
        SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
        //设置使用termQuery
        searchSourceBuilder.query(QueryBuilders.termQuery("id",id));
        //过虑源字段，不用设置源字段，取出所有字段
//        searchSourceBuilder.fetchSource()
        searchRequest.source(searchSourceBuilder);
        //最终要返回的课程信息

        Map<String,CoursePub> map = new HashMap<>();
        try {
            SearchResponse search = restHighLevelClient.search(searchRequest);
            SearchHits hits = search.getHits();
            SearchHit[] searchHits = hits.getHits();
            for(SearchHit hit:searchHits){
                CoursePub coursePub = new CoursePub();
                //获取源文档的内容
                Map<String, Object> sourceAsMap = hit.getSourceAsMap();
                //课程id
                String courseId = (String) sourceAsMap.get("id");
                String name = (String) sourceAsMap.get("name");
                String grade = (String) sourceAsMap.get("grade");
                String charge = (String) sourceAsMap.get("charge");
                String pic = (String) sourceAsMap.get("pic");
                String description = (String) sourceAsMap.get("description");
                String teachplan = (String) sourceAsMap.get("teachplan");
                coursePub.setId(courseId);
                coursePub.setName(name);
                coursePub.setPic(pic);
                coursePub.setGrade(grade);
                coursePub.setTeachplan(teachplan);
                coursePub.setDescription(description);
                map.put(courseId,coursePub);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }


        return map;
    }
```

#### 测试

```
http://localhost:40100/swagger-ui.html#/
```

#### 前端开发

#### 配置虚拟主机

学习中心的二级域名为ucenter.xuecheng.com，我们在nginx中配置ucenter虚拟主机。

```
#学成网用户中心
server {
    listen       80;
    server_name ucenter.xuecheng.com;
    
    #个人中心
    location / {  
        proxy_pass http://ucenter_server_pool;  
    } 
}
#前端ucenter
upstream ucenter_server_pool{
  #server 127.0.0.1:7081 weight=10;
  server 127.0.0.1:13000 weight=10;
}
```

在学习中心要调用搜索的API，使用Nginx解决代理，如下图：

配置搜索Api代理路径：

```
 
#后台搜索（公开api）
upstream search_server_pool{
    server 127.0.0.1:40100 weight=10;
}
#后端搜索服务
location /openapi/search/ {  
    proxy_pass http://search_server_pool/search/;  
} 
```

#### API

在学习中心对课程信息的查询属于基础常用功能，所以我们将课程查询的api方法定义在base模块下，如下图：

![1525925482949](file:///E:/%E4%BC%A0%E6%99%BA%E5%B7%A5%E4%BD%9C/%E5%A4%87%E8%AF%BE%E8%B5%84%E6%96%99/JavaEE%E5%9C%A8%E7%BA%BF%E5%B0%B1%E4%B8%9A%E7%8F%AD%E8%AF%BE%E7%A8%8B%E8%B5%84%E6%96%99/7.%E9%98%B6%E6%AE%B5%E4%B8%83-%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/01-HTML%E7%89%88%E6%9C%AC%E8%AE%B2%E4%B9%89(%E8%AF%B7%E4%BD%BF%E7%94%A8HTML%E7%89%88%E6%9C%AC%E8%AE%B2%E4%B9%89%E5%AD%A6%E4%B9%A0)/HTML%E7%89%88%E6%9C%AC/day15%20%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E9%9B%86%E6%88%90/images/1525925482949.png)

在system.js中定义课程查询方法：

```
import http from './public'

export const course_view = id => {
  return http.requestGet('/openapi/search/course/getall/'+id);
}
```

#### API调用

在learning_video.vue页面中调用课程信息查询接口，得到课程计划，将课程计划json串转成对象。

##### 1.定义视图

​	a、课程计划

```
                <div class="nav nav-stacked" v-for="(teachplan_first, index) in teachplanList">
                  <div class="tit nav-justified text-center"><i class="pull-left glyphicon glyphicon-th-list"></i>{{teachplan_first.pname}}<i class="pull-right"></i></div>
                  <li   v-if="teachplan_first.children!=null" v-for="(teachplan_second, index) in teachplan_first.children"><i class="glyphicon glyphicon-check"></i>
                    <a :href="url" @click="study(teachplan_second.id)">
                      {{teachplan_second.pname}}
                    </a>
                  </li>
                </div>
```

​	b、课程名称

```
            <div class="top text-center">
             {{coursename}}
            </div>
```

##### 2.定义数据对象

```
    data() {
      return {
        url:'',//当前url
        courseId:'',//课程id
        chapter:'',//章节Id
        coursename:'课程名称',//课程名称
        coursepic:'',//课程图片
        teachplanList:[],//课程计划
        playerOptions: {//播放参数
          autoplay: false,
          controls: true,
          sources: [{
            type: "application/x-mpegURL",
            src: ''
          }]
        },

      }
    },
```

##### 3.在created钩子方法中获取课程信息

```

```





