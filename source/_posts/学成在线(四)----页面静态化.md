# 1.为什么要页面静态化

1、为什么要进行页面管理？ 
 本项目cms系统的功能就是根据运营需要，对门户等子系统的部分页面进行管理，从而实现快速根据用户需求修改 页面内容并上线的需求。
2、如何修改页面的内容？ 
 在开发中修改页面内容是需要人工编写html及JS文件，CMS系统是通过程序自动化的对页面内容进行修改，通过 
页面静态化技术生成html页面。
3、如何对页面进行静态化？
一个页面等于模板加数据，在添加页面的时候我们选择了页面的模板。 
页面静态化就是将页面模板和数据通过技术手段将二者合二为一，生成一个html网页文件。 
4、页面静态化及页面发布流程图如下：

![1569980605549](C:\Users\85896\AppData\Roaming\Typora\typora-user-images\1569980605549.png)

业务流程如下： 

1、获取模型数据 

2、制作模板

3、对页面进行静态化 

4、将静态化生成的html页面存放文件系统中 5、将存放在文件系统的html文件发布到服务器



### 页面静态化的好处 :

```
1.静态网页化可以提高速度 不管是asp、php、jsp、.net等动态程序，都需要读取调用数据库内容，才能显示数据，相对于流量比较大，就增加了数据库的读取次数，占用很大的服务器资源，影响网站速度。而采用网站做成静态的，直接除去了读取数据库的操作，减少了环节，还提高了网站反映速度。 

2.静态网页化有利于搜索引擎的收录 从网站优化来分析，搜索引擎更喜欢静态的网页，静态网页与动态网页相比，搜索引擎更喜欢静的，更便于抓取，搜索引擎SEO排名更容易提高，目前一些门户网站，如新浪、搜狐、网易、阿里巴巴、百度、慧聪等，页面大多都采用静态或伪静态网页来显示，更便于搜索引擎抓取与排名。 

3.静态网页化有利于网站稳定 

	1、从安全角度讲，静态网页不宜遭到黑客攻击，但也说不定，黑客能耐大着呢 

	2、从网站稳定性来讲，如果程序、数据库出了问题，会直接影响网站的访问，而静态网页就避免了如此情况，不会因为程序等，而损失网站数据，影响正常打开。

4.静态页面是网页的代码都在页面中，不需要执行asp,php,jsp,.net等程序生成客户端网页代码的网页，静态页面网址中一般不含“？”、“=”、“&”等特殊符号。静态页面不能自主管理发布更新的页面，如果想更新网页内容，要通过FTP软件把文件DOWN下来用网页制作软件修改（通过fso等技术例外） 常见的静态页面举例：.html扩展名的、.htm扩展名的。 
注意：静态页面并非网站上没有动画的就是静态页面。
```

# 2.Freemarker

freemarker是一个用Java开发的模板引擎

![1569980877272](C:\Users\85896\AppData\Roaming\Typora\typora-user-images\1569980877272.png)

![1569980880893](C:\Users\85896\AppData\Roaming\Typora\typora-user-images\1569980880893.png)

常用的java模板引擎还有哪些？ Jsp、Freemarker、Thymeleaf 、Velocity 等。

2、模板+数据模型=输出 
 freemarker并不关心数据的来源，只是根据模板的内容，将数据模型在模板中显示并输出文件（通常为html，也 可以生成其它格式的文本文件）
1、数据模型
数据模型在java中可以是基本类型也可以List、Map、Pojo等复杂类型。 
2、来自官方的例子：（https://freemarker.apache.org/docs/dgui_quickstart_basics.html） 
数据模型：

![1569981246682](C:\Users\85896\AppData\Roaming\Typora\typora-user-images\1569981246682.png)

模板：

![1569981261596](C:\Users\85896\AppData\Roaming\Typora\typora-user-images\1569981261596.png)

输出：

![1569981275651](C:\Users\85896\AppData\Roaming\Typora\typora-user-images\1569981275651.png)

# 3.FreeMarker快速入门

### 1.创建测试工程

![1569981666402](C:\Users\85896\AppData\Roaming\Typora\typora-user-images\1569981666402.png)

### 2.导入依赖

```
		<dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-freemarker</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
        <dependency>
            <groupId>com.squareup.okhttp3</groupId>
            <artifactId>okhttp</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
        </dependency>
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-io</artifactId>
        </dependency>
```

### 3.配置文件

配置application.yml和 logback-spring.xml，从cms工程拷贝这两个文件，进行更改， logback-spring.xml无需更 改，application.yml内容如下：

```
server:
  port: 8088 #服务端口

spring:
  application:
    name: test-freemarker #指定服务名
  freemarker:
    cache: false  #关闭模板缓存，方便测试
    settings:
      template_update_delay: 0 #检查模板更新延迟时间，设置为0表示立即检查，如果时间大于0会有缓存不方便进行模板测试
```

### 4.创建模型类

在freemarker的测试工程下创建模型类型用于测试

```
package com.xuecheng.test.freemarker.model;

import lombok.Data;
import lombok.ToString;

import java.util.Date;
import java.util.List;

@Data
@ToString
public class Student {
    private String name;//姓名
    private int age;//年龄
    private Date birthday;//生日
    private Float mondy;//钱包
    private List<Student> friends;//朋友列表
    private Student bestFriend;//最好的朋友
}
```

### 5.创建模板

在 src/main/resources下创建templates，此目录为freemarker的默认模板存放目录。 
在templates下创建模板文件test1.ftl，模板中的${name}最终会被freemarker替换成具体的数据。

```
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf‐8">
    <title>Hello World!</title>
</head>
<body>
Hello ${name}!
</body>
</html>
```

### 6.创建controller

创建Controller类，向Map中添加name，最后返回模板文件。

```
package com.xuecheng.test.freemarker.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.client.RestTemplate;

import java.util.Map;

@RequestMapping("/freemarker")
@Controller
public class FreemarkerController {
    @Autowired
    RestTemplate restTemplate;

    @RequestMapping("/test1")
    public String freemarker(Map<String, Object> map) {
        map.put("name", "黑马程序员");
        //返回模板文件名称
        return "test1";
    }
}
```

### 7.创建启动类

```
@SpringBootApplication
public class FreemarkerTestApplication {
    public static void main(String[] args) {
        SpringApplication.run(FreemarkerTestApplication.class, args);
    }

    @Bean
    public RestTemplate restTemplate() {
        return new RestTemplate(new OkHttp3ClientHttpRequestFactory());
    }
}
```

### 8.测试

```
请求：http://localhost:8088/freemarker/test1 
屏幕显示：Hello 黑马程序员!
```

# 4.FreeMarker基础

### 1.准备数据模型

```
@RequestMapping("/test1")
    public String freemarker(Map<String, Object> map){
        //向数据模型放数据
        map.put("name","黑马程序员");


        Student stu1 = new Student();
        stu1.setName("小明");
        stu1.setAge(18);
        stu1.setMondy(1000.86f);
        stu1.setBirthday(new Date());


        Student stu2 = new Student();
        stu2.setName("小红");
        stu2.setMondy(200.1f);
        stu2.setAge(19);
//        stu2.setBirthday(new Date());
        List<Student> friends = new ArrayList<>();
        friends.add(stu1);
        stu2.setFriends(friends);
        stu2.setBestFriend(stu1);


        List<Student> stus = new ArrayList<>();
        stus.add(stu1);
        stus.add(stu2);

        //向数据模型放数据
        map.put("stus",stus);
        //准备map数据
        HashMap<String,Student> stuMap = new HashMap<>();
        stuMap.put("stu1",stu1);
        stuMap.put("stu2",stu2);
        //向数据模型放数据
        map.put("stu1",stu1);
        //向数据模型放数据
        map.put("stuMap",stuMap);
        //返回模板文件名称
        return "test1";
    }
```

### 2.List

本节定义freemarker模板，模板中使用freemarker的指令，关于freemarker的指令需要知道：

```
1、注释，即<#‐‐和‐‐>，介于其之间的内容会被freemarker忽略 
2、插值（Interpolation）：即${..}部分,freemarker会用真实的值代替${..} 
3、FTL指令：和HTML标记类似，名字前加#予以区分，Freemarker会解析标签中的表达式或逻辑。 
4、文本，仅文本信息，这些不是freemarker的注释、插值、FTL指令的内容会被freemarker忽略解析，直接输出内容。
```

在test1.ftl模板中使用list指令遍历数据模型中的数据：

```
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf‐8">
    <title>Hello World!</title>
</head>
<body>
Hello ${name}!

<table>
    <tr>
        <td>序号</td>
        <td>姓名</td>
        <td>年龄</td>
        <td>钱包</td>
    </tr>
        <#list stus as stu>
    <tr>
        <td>${stu_index + 1}</td>
        <td>${stu.name}</td>
        <td>${stu.age}</td>
        <td>${stu.mondy}</td>
    </tr>
    </#list>
</table>
</body>
</html>
```

说明： 
_index：得到循环的下标，使用方法是在stu后边加"_index"，它的值是从0开始

### 3.测试

```
http://localhost:8088/freemarker/test1 
```

### 4.map

使用map指令遍历数据模型中的stuMap

```
输出stu1的学生信息：<br/>
姓名：${stuMap['stu1'].name}<br/>
年龄：${stuMap['stu1'].age}<br/>
输出stu1的学生信息：<br/>
姓名：${stu1.name}<br/>
年龄：${stu1.age}<br/>
遍历输出两个学生信息：<br/>
<table>
    <tr>
        <td>序号</td>
        <td>姓名</td>
        <td>年龄</td>
        <td>钱包</td>
    </tr>
<#list stuMap?keys as k>
<tr>
    <td>${k_index + 1}</td>
    <td>${stuMap[k].name}</td>
    <td>${stuMap[k].age}</td>
    <td>${stuMap[k].mondy}</td>
</tr>
</#list>
</table>
</br>
<table>
    <tr>
        <td>姓名</td>
        <td>年龄</td>
        <td>出生日期</td>
        <td>钱包</td>
        <td>最好的朋友</td>
        <td>朋友个数</td>
        <td>朋友列表</td>
    </tr>
    <#if stus??>
        <#list stus as stu>
        <tr>
            <td>${stu.name!''}</td>
            <td>${stu.age}</td>
            <td>${(stu.birthday?date)!''}</td>
            <td>${stu.mondy}</td>
            <td>${(stu.bestFriend.name)!''}</td>
            <td>${(stu.friends?size)!0}</td>
            <td>
                <#if stu.friends??>
                <#list stu.friends as firend>
                    ${firend.name!''}<br/>
                </#list>
                </#if>
            </td>
        </tr>
        </#list>
    </#if>

</table>
<br/>
```

### 5.if

if 指令即判断指令，是常用的FTL指令，freemarker在解析时遇到if会进行判断，条件为真则输出if中间的内容，否 则跳过内容不再输出。

```
<table>
    <tr>
        <td>序号</td>
        <td>姓名</td>
        <td>年龄</td>
        <td>钱包</td>
    </tr>
    <#list stus as stu>
        <tr>
            <td>${stu_index + 1}</td>
            <td <#if stu.name =='小明'>style="background:red;"</#if>>${stu.name}</td>
            <td>${stu.age}</td>
            <td >${stu.mondy}</td>
        </tr>
    </#list>
</table>
```

### 6.运算符

1、算数运算符 FreeMarker表达式中完全支持算术运算,FreeMarker支持的算术运算符包括:+, - , * , / , % 

2、逻辑 运算符 逻辑运算符有如下几个: 逻辑与:&& 逻辑或:|| 逻辑非:! 逻辑运算符只能作用于布尔值,否则将产生错误 

3、 比较运算符 表达式中支持的比较运算符有如下几个: 
​	1 =或者==:判断两个值是否相等. 
​	2 !=:判断两个值是否不等. 
​	3 >或者gt:判断左边值是否大于右边值 
​	4 >=或者gte:判断左边值是否大于等于右边值 
​	5 <或者lt:判断左边值是否小于右 边值 
​	6 <=或者lte:判断左边值是否小于等于右边值

注意: =和!=可以用于字符串,数值和日期来比较是否相等,但=和!=两边必须是相同类型的值,否则会产生错误,而且 FreeMarker是精确比较,"x","x ","X"是不等的.其它的运行符可以作用于数字和日期,但不能作用于字符串,大部分的时候,使用gt等字母运算符代替>会有更好的效果,因为 FreeMarker会把>解释成FTL标签的结束字符,当然,也可以使用括号来避免这种情况,如:<#if (x>y)>

### 7.空值

1、判断某变量是否存在使用 “??” 用法为:variable??,如果该变量存在,返回true,否则返回false 
例：为防止stus为空报错可以加上判断如下：

```
<#if stus??>
    <#list stus as stu>
        <tr>
            <td>${stu.name!''}</td>
            <td>${stu.age}</td>
            <td>${(stu.birthday?date)!''}</td>
            <td>${stu.mondy}</td>
            <td>${(stu.bestFriend.name)!''}</td>
            <td>${(stu.friends?size)!0}</td>
            <td>
                <#if stu.friends??>
                <#list stu.friends as firend>
                    ${firend.name!''}<br/>
                </#list>
                </#if>
            </td>
        </tr>
    </#list>
    </#if>
```

缺失变量默认值使用 “!” 使用!要以指定一个默认值，当变量为空时显示默认值。 例： ${name!''}表示如果name为空显示空字符串。

如果是嵌套对象则建议使用（）括起来。

```
例： ${(stu.bestFriend.name)!''}表示，如果stu或bestFriend或name为空默认显示空字符串。
```

### 8.内建函数

内建函数语法格式： 变量+?+函数名称 

#### 1.某个集合的大小

```
${集合名?size}
```

#### 2.日期格式化

```
显示年月日: ${today?date} 
显示时分秒：${today?time} 
显示日期+时间：${today?datetime} <br>
自定义格式化：  ${today?string("yyyy年MM月")}
```

#### 3.内建函数c

```
map.put("point", 102920122);
point是数字型，使用${point}会显示这个数字的值，每三位使用逗号分隔。
如果不想显示为每三位分隔的数字，可以使用c函数将数字型转成字符串输出 ${point?c}
```

#### 4.将json字符串转成对象

```
<#assign text="{'bank':'工商银行','account':'10101920201920212'}" />
<#assign data=text?eval />
开户行：${data.bank} 账号：${data.account}
```

### 9.完整的模板

```
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Hello World!</title>
</head>
<body>
Hello ${name}!
<br/>
<table>
    <tr>
        <td>序号</td>
        <td>姓名</td>
        <td>年龄</td>
        <td>钱包</td>
    </tr>
    <#list stus as stu>
        <tr>
            <td>${stu_index + 1}</td>
            <td <#if stu.name =='小明'>style="background:red;"</#if>>${stu.name}</td>
            <td>${stu.age}</td>
            <td >${stu.mondy}</td>
        </tr>
    </#list>

</table>
<br/><br/>
输出stu1的学生信息：<br/>
姓名：${stuMap['stu1'].name}<br/>
年龄：${stuMap['stu1'].age}<br/>
输出stu1的学生信息：<br/>
姓名：${stu1.name}<br/>
年龄：${stu1.age}<br/>
遍历输出两个学生信息：<br/>
<table>
    <tr>
        <td>序号</td>
        <td>姓名</td>
        <td>年龄</td>
        <td>钱包</td>
    </tr>
<#list stuMap?keys as k>
<tr>
    <td>${k_index + 1}</td>
    <td>${stuMap[k].name}</td>
    <td>${stuMap[k].age}</td>
    <td >${stuMap[k].mondy}</td>
</tr>
</#list>
</table>
</br>
<table>
    <tr>
        <td>姓名</td>
        <td>年龄</td>
        <td>出生日期</td>
        <td>钱包</td>
        <td>最好的朋友</td>
        <td>朋友个数</td>
        <td>朋友列表</td>
    </tr>
    <#if stus??>
    <#list stus as stu>
        <tr>
            <td>${stu.name!''}</td>
            <td>${stu.age}</td>
            <td>${(stu.birthday?date)!''}</td>
            <td>${stu.mondy}</td>
            <td>${(stu.bestFriend.name)!''}</td>
            <td>${(stu.friends?size)!0}</td>
            <td>
                <#if stu.friends??>
                <#list stu.friends as firend>
                    ${firend.name!''}<br/>
                </#list>
                </#if>
            </td>
        </tr>
    </#list>
    </#if>

</table>
<br/>
<#assign text="{'bank':'工商银行','account':'10101920201920212'}" />
<#assign data=text?eval />
开户行：${data.bank}  账号：${data.account}

</body>
</html>
```

### 10.测试模板文件静态化

在test下创建测试类，并且将main下的resource/templates拷贝到test下，本次测试使用之前我们在main下创建 的模板文件。

```
package com.xuecheng.test.freemarker;

import com.xuecheng.test.freemarker.model.Student;
import freemarker.cache.StringTemplateLoader;
import freemarker.template.Configuration;
import freemarker.template.Template;
import freemarker.template.TemplateException;
import org.apache.commons.io.IOUtils;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.ui.freemarker.FreeMarkerTemplateUtils;

import java.io.*;
import java.util.*;

@SpringBootTest
@RunWith(SpringRunner.class)
public class FreemarkerTest {

    //基于模板生成静态化文件
    @Test
    public void testGenerateHtml() throws IOException, TemplateException {
        //创建配置类
        Configuration configuration=new Configuration(Configuration.getVersion());
        String classpath = this.getClass().getResource("/").getPath();
        //设置模板路径
        configuration.setDirectoryForTemplateLoading(new File(classpath + "/templates/"));
        //设置字符集
        configuration.setDefaultEncoding("utf-8");
        //加载模板
        Template template = configuration.getTemplate("test1.ftl");
        //数据模型
        Map map = getMap();
        //静态化
        String content = FreeMarkerTemplateUtils.processTemplateIntoString(template, map);
        //静态化内容
        System.out.println(content);
        InputStream inputStream = IOUtils.toInputStream(content);
        //输出文件
        FileOutputStream fileOutputStream = new FileOutputStream(new File("d:/test1.html"));
        int copy = IOUtils.copy(inputStream, fileOutputStream);
    }

    //基于模板字符串生成静态化文件
    @Test
    public void testGenerateHtmlByString() throws IOException, TemplateException {
        //创建配置类
        Configuration configuration=new Configuration(Configuration.getVersion());
        //获取模板内容
        //模板内容，这里测试时使用简单的字符串作为模板
        String templateString="" +
                "<html>\n" +
                "    <head></head>\n" +
                "    <body>\n" +
                "    名称：${name}\n" +
                "    </body>\n" +
                "</html>";

        //加载模板
        //模板加载器
        StringTemplateLoader stringTemplateLoader = new StringTemplateLoader();
        stringTemplateLoader.putTemplate("template",templateString);
        configuration.setTemplateLoader(stringTemplateLoader);
        Template template = configuration.getTemplate("template","utf-8");

        //数据模型
        Map map = getMap();
        //静态化
        String content = FreeMarkerTemplateUtils.processTemplateIntoString(template, map);
        //静态化内容
        System.out.println(content);
        InputStream inputStream = IOUtils.toInputStream(content);
        //输出文件
        FileOutputStream fileOutputStream = new FileOutputStream(new File("d:/test1.html"));
        IOUtils.copy(inputStream, fileOutputStream);
    }

    //数据模型
    private Map getMap(){
        Map<String, Object> map = new HashMap<>();
        //向数据模型放数据
        map.put("name","黑马程序员");
        Student stu1 = new Student();
        stu1.setName("小明");
        stu1.setAge(18);
        stu1.setMondy(1000.86f);
        stu1.setBirthday(new Date());
        Student stu2 = new Student();
        stu2.setName("小红");
        stu2.setMondy(200.1f);
        stu2.setAge(19);
//        stu2.setBirthday(new Date());
        List<Student> friends = new ArrayList<>();
        friends.add(stu1);
        stu2.setFriends(friends);
        stu2.setBestFriend(stu1);
        List<Student> stus = new ArrayList<>();
        stus.add(stu1);
        stus.add(stu2);
        //向数据模型放数据
        map.put("stus",stus);
        //准备map数据
        HashMap<String,Student> stuMap = new HashMap<>();
        stuMap.put("stu1",stu1);
        stuMap.put("stu2",stu2);
        //向数据模型放数据
        map.put("stu1",stu1);
        //向数据模型放数据
        map.put("stuMap",stuMap);
        return map;
    }
}
```

# 5.页面静态化

### 1.页面静态化流程

通过上边对FreeMarker的研究我们得出：模板+数据模型=输出，页面静态化需要准备数据模型和模板，先知道数 
据模型的结构才可以编写模板，因为在模板中要引用数据模型中的数据，本节将系统讲解CMS页面数据模型获取、 模板管理及静态化的过程。
下边讨论一个问题：如何获取页面的数据模型？ 
CMS管理了各种页面，CMS对页面进行静态化时需要数据模型，但是CMS并不知道每个页面的数据模型的具体内 容，它只管执行静态化程序便可对页面进行静态化，所以CMS静态化程序需要通过一种通用的方法来获取数据模 型。 
在编辑页面信息时指定一个DataUrl，此DataUrl便是获取数据模型的Url，它基于Http方式，CMS对页面进行静态 化时会从页面信息中读取DataUrl，通过Http远程调用的方法请求DataUrl获取数据模型。
管理员怎么知道DataUrl的内容呢？
举例说明： 
此页面是轮播图页面，它的DataUrl由开发轮播图管理的程序员提供。 
此页面是精品课程推荐页面，它的DataUrl由精品课程推荐的程序员提供。 
此页面是课程详情页面，它的DataUrl由课程管理的程序员提供。 
页面静态化流程如下图：
1、静态化程序首先读取页面获取DataUrl。 
2、静态化程序远程请求DataUrl得到数据模型。
3、获取页面模板。
4、执行页面静态化。

![1570002932292](C:\Users\85896\AppData\Roaming\Typora\typora-user-images\1570002932292.png)

### 2.获取数据模型

CMS中有轮播图管理、精品课程推荐的功能，以轮播图管理为例说明：轮播图管理是通过可视化的操作界面由管理 员指定轮播图图片地址，最后将轮播图图片地址保存在cms_conﬁg集合中，下边是轮播图数据模型：

![1570003084920](C:\Users\85896\AppData\Roaming\Typora\typora-user-images\1570003084920.png)

 针对首页的轮播图信息、精品推荐等信息的获取统一提供一个Url供静态化程序调用，这样我们就知道了轮播图页 面、精品课程推荐页面的DataUrl，管理在页面配置中将此Url配置在页面信息中。 
本小节开发一个查询轮播图、精品推荐信息的接口，此接口供静态化程序调用获取数据模型。

#### 1.接口定义

轮播图信息、精品推荐等信息存储在MongoDB的cms_conﬁg集合中。

![1570007010261](C:\Users\85896\AppData\Roaming\Typora\typora-user-images\1570007010261.png)

cms_conﬁg有固定的数据结构，如下：

```
@Data
@ToString
@Document(collection = "cms_config")
public class CmsConfig {

    @Id
    private String id;
    private String name;
    private List<CmsConfigModel> model;

}
```

数据模型项目内容如下：

```
@Data
@ToString
public class CmsConfigModel {
    private String key;
    private String name;
    private String url;
    private Map mapValue;
    private String value;

}
```

上边的模型结构可以对照cms_conﬁg中的数据进行分析。 

其中，在mapValue 中可以存储一些复杂的数据模型内容。 



根据配置信息Id查询配置信息，定义接口如下：

```
@Api(value="cms配置管理接口",description = "cms配置管理接口，提供数据模型的管理、查询接口")
public interface CmsConfigControllerApi {
    @ApiOperation("根据id查询CMS配置信息")
    public CmsConfig getmodel(String id);
}
```

####  2.Dao

```
public interface CmsConfigRepository extends MongoRepository<CmsConfig,String> {
}
```

#### 3.Service

```
@Service
public class CmsConfigService {
    @Autowired
    CmsConfigRepository cmsConfigRepository;
    //根据id查询配置管理信息
    public CmsConfig getConfigById(String id){
        Optional<CmsConfig> optional = cmsConfigRepository.findById(id);
        if(optional.isPresent()){
            CmsConfig cmsConfig = optional.get();
            return cmsConfig;
        }
        return null;
    }
}
```

#### 4.Controller

```
@RestController
@RequestMapping("/cms/config")
public class CmsConfigController implements CmsConfigControllerApi {
    @Autowired
    CmsConfigService cmsConfigService;

    @Override
    @GetMapping("/getmodel/{id}")
    public CmsConfig getmodel(String id) {
        return cmsConfigService.getConfigById(id);
    }
}
```

#### 5.测试

```
http://localhost:31001/swagger-ui.html#
```

#### 6.RestTemplate

SpringMVC提供 RestTemplate请求http接口，RestTemplate的底层可以使用第三方的http客户端工具实现http 的 请求，常用的http客户端工具有Apache HttpClient、OkHttpClient等，本项目使用OkHttpClient完成http请求， 原因也是因为它的性能比较出众。

##### 1.添加依赖

```
        <dependency>
            <groupId>com.squareup.okhttp3</groupId>
            <artifactId>okhttp</artifactId>
        </dependency>
```

##### 2.启动类配置RestTemplate 

```
public class ManageCmsApplication {
    public static void main(String[] args) {
        SpringApplication.run(ManageCmsApplication.class,args);
    }

 @Bean
    public RestTemplate restTemplate() {
        return new RestTemplate(new OkHttp3ClientHttpRequestFactory());     }
}
```

##### 3.创建测试类测试RestTemplateTest

```
@SpringBootTest
@RunWith(SpringRunner.class)
public class RestTemplateTest {
    @Autowired
    RestTemplate restTemplate;

    @Test
    public void testRestTemplate(){
        ResponseEntity<Map> forEntity = restTemplate.getForEntity("http://localhost:31001/cms/config/getmodel/5a791725dd573c3574ee333f", Map.class);
        Map body = forEntity.getBody();
        System.out.println(body);
    }
}
```

### 3.制作模板

CMS提供模板管理功能，业务流程如下：

![1570018532444](C:\Users\85896\AppData\Roaming\Typora\typora-user-images\1570018532444.png)

1、要增加新模板首先需要制作模板，模板的内容就是Freemarker ftl模板内容。 
2、通过模板管理模块功能新增模板、修改模板、删除模板。 
3、模板信息存储在MongoDB数据库，其中模板信息存储在cms_template集合中，模板文件存储在GridFS文件系 统中。

cms_template集合： 
下边是一个模板的例子：

```
{ 
    "_id" : ObjectId("5a962b52b00ffc514038faf7"), 
    "_class" : "com.xuecheng.framework.domain.cms.CmsTemplate", 
    "siteId" : "5a751fab6abb5044e0d19ea1", 
    "templateName" : "首页", 
    "templateParameter" : "", 
    "templateFileId" : "5a962b52b00ffc514038faf5"
}
```

上边模板信息中templateFileId是模板文件的ID，此ID对应GridFS文件系统中文件ID。

#### 1.轮播图页面原型 
在门户的静态工程目录有轮播图的静态页面，路径是：/include/index_banner.html。

```
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="http://www.xuecheng.com/plugins/normalize-css/normalize.css" />
    <link rel="stylesheet" href="http://www.xuecheng.com/plugins/bootstrap/dist/css/bootstrap.css" />
    <link rel="stylesheet" href="http://www.xuecheng.com/css/page-learing-index.css" />
    <link rel="stylesheet" href="http://www.xuecheng.com/css/page-header.css" />
</head>
<body>
<div class="banner-roll">
    <div class="banner-item">
        <div class="item" style="background-image: url(../img/widget-bannerB.jpg);"></div>
        <div class="item" style="background-image: url(../img/widget-bannerA.jpg);"></div>
        <div class="item" style="background-image: url(../img/widget-banner3.png);"></div>
        <div class="item" style="background-image: url(../img/widget-bannerB.jpg);"></div>
        <div class="item" style="background-image: url(../img/widget-bannerA.jpg);"></div>
        <div class="item" style="background-image: url(../img/widget-banner3.png);"></div>
    </div>
    <div class="indicators"></div>
</div>
<script type="text/javascript" src="/plugins/jquery/dist/jquery.js"></script>
<script type="text/javascript" src="/plugins/bootstrap/dist/js/bootstrap.js"></script>
<script type="text/javascript">
    var tg = $('.banner-item .item');
    var num = 0;
    for (i = 0; i < tg.length; i++) {
        $('.indicators').append('<span></span>');
        $('.indicators').find('span').eq(num).addClass('active');
    }

    function roll() {
        tg.eq(num).animate({
            'opacity': '1',
            'z-index': num
        }, 1000).siblings().animate({
            'opacity': '0',
            'z-index': 0
        }, 1000);
        $('.indicators').find('span').eq(num).addClass('active').siblings().removeClass('active');
        if (num >= tg.length - 1) {
            num = 0;
        } else {
            num++;
        }
    }
    $('.indicators').find('span').click(function() {
        num = $(this).index();
        roll();
    });
    var timer = setInterval(roll, 3000);
    $('.banner-item').mouseover(function() {
        clearInterval(timer)
    });
    $('.banner-item').mouseout(function() {
        timer = setInterval(roll, 3000)
    });
</script>
</body>
</html>
```

#### 2.数据模型为
通过http 获取到数据模型如下： 
下图数据模型的图片路径改成可以浏览的正确路径。

```
{ 
    "_id" : ObjectId("5a791725dd573c3574ee333f"), 
    "_class" : "com.xuecheng.framework.domain.cms.CmsConfig", 
    "name" : "轮播图", 
    "model" : [
        {
            "key" : "banner1", 
            "name" : "轮播图1地址", 
            "value" : "http://www.xuecheng.com/img/widget-bannerB.jpg"
        }, 
        {
            "key" : "banner2", 
            "name" : "轮播图2地址", 
            "value" : "http://www.xuecheng.com/img/widget‐bannerA.jpg"
        }, 
        {
            "key" : "banner3", 
            "name" : "轮播图3地址", 
            "value" : "http://www.xuecheng.com/img/widget‐banner3.jpg"
        }
    ]
}
```

#### 3.编写模板 

在freemarker测试工程中resources/templates新建模板index_banner.ftl。

```
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="http://www.xuecheng.com/plugins/normalize-css/normalize.css" />
    <link rel="stylesheet" href="http://www.xuecheng.com/plugins/bootstrap/dist/css/bootstrap.css" />
    <link rel="stylesheet" href="http://www.xuecheng.com/css/page-learing-index.css" />
    <link rel="stylesheet" href="http://www.xuecheng.com/css/page-header.css" />
</head>
<body>
<div class="banner-roll">
    <div class="banner-item">
        <#--<div class="item" style="background-image: url(http://www.xuecheng.com/img/widget-bannerB.jpg);"></div>
        <div class="item" style="background-image: url(http://www.xuecheng.com/img/widget-bannerA.jpg);"></div>
        <div class="item" style="background-image: url(http://www.xuecheng.com/img/widget-banner3.png);"></div>
        <div class="item" style="background-image: url(http://www.xuecheng.com/img/widget-bannerB.jpg);"></div>
        <div class="item" style="background-image: url(http://www.xuecheng.com/img/widget-bannerA.jpg);"></div>
        <div class="item" style="background-image: url(http://www.xuecheng.com/img/widget-banner3.png);"></div>-->
        <#if model??>
            <#list model as item>
                 <div class="item" style="background-image: url(${item.value});"></div>
            </#list>
        </#if>
    </div>
    <div class="indicators"></div>
</div>
<script type="text/javascript" src="http://www.xuecheng.com/plugins/jquery/dist/jquery.js"></script>
<script type="text/javascript" src="http://www.xuecheng.com/plugins/bootstrap/dist/js/bootstrap.js"></script>
<script type="text/javascript">
    var tg = $('.banner-item .item');
    var num = 0;
    for (i = 0; i < tg.length; i++) {
        $('.indicators').append('<span></span>');
        $('.indicators').find('span').eq(num).addClass('active');
    }

    function roll() {
        tg.eq(num).animate({
            'opacity': '1',
            'z-index': num
        }, 1000).siblings().animate({
            'opacity': '0',
            'z-index': 0
        }, 1000);
        $('.indicators').find('span').eq(num).addClass('active').siblings().removeClass('active');
        if (num >= tg.length - 1) {
            num = 0;
        } else {
            num++;
        }
    }
    $('.indicators').find('span').click(function() {
        num = $(this).index();
        roll();
    });
    var timer = setInterval(roll, 3000);
    $('.banner-item').mouseover(function() {
        clearInterval(timer)
    });
    $('.banner-item').mouseout(function() {
        timer = setInterval(roll, 3000)
    });
</script>
</body>
</html>
```

#### 4.编写controller

在freemarker测试工程FreemarkerController类中编写一个方法测试轮播图模板，代码如下：

```
    @Autowired
    RestTemplate restTemplate;

    @RequestMapping("/banner")
    public String index_banner(Map<String, Object> map){
        //使用restTemplate请求轮播图的模型数据
        ResponseEntity<Map> forEntity = restTemplate.getForEntity("http://localhost:31001/cms/config/getmodel/5a791725dd573c3574ee333f", Map.class);
        Map body = forEntity.getBody();
        //设置模型数据
        map.putAll(body);
        return "index_banner";
    }
```

#### 5.测试 

```
http://localhost:8088/freemarker/banner
```

### 4.GridFS

#### 1.GridFS介绍

GridFS是MongoDB提供的用于持久化存储文件的模块，CMS使用MongoDB存储数据，使用GridFS可以快速集成开发。

它的工作原理是： 
在GridFS存储文件是将文件分块存储，文件会按照256KB的大小分割成多个块进行存储，GridFS使用两个集合 （collection）存储文件:
		一个集合是chunks, 用于存储文件的二进制数据；
		一个集合是ﬁles，用于存储文件的元数据信息（文件名称、块大小、上传时间等信息）。

从GridFS中读取文件要对文件的各各块进行组装、合并。 
详细参考：https://docs.mongodb.com/manual/core/gridfs/

#### 2.GridFS存文件

使用GridFsTemplate存储文件测试代码： 
在cms模块test中向GridFsTest类注入GridFsTemplat

```
public class GridFsTest {

    @Autowired
    GridFsTemplate gridFsTemplate;

    //存文件
    @Test
    public void testStore() throws FileNotFoundException {
        //要存储的文件
        File file =new File("e:/index_banner.ftl");
        //定义输入流
        FileInputStream fileInputStream = new FileInputStream(file);
        //向GridFS存储文件
        ObjectId objectId = gridFsTemplate.store(fileInputStream, "index_banner.ftl");
        //得到文件ID
        System.out.println(objectId);
    }
}
```

存储原理说明：
文件存储成功得到一个文件id 
此文件id是fs.ﬁles集合中的主键。 
可以通过文件id查询fs.chunks表中的记录，得到文件的内容。

#### 3.GridFS取文件

在conﬁg包中定义Mongodb的配置类，如下： 

GridFSBucket用于打开下载流对象

```
@Configuration
public class MongoConfig {

    @Value("${spring.data.mongodb.database}")
    String db;

    @Bean
    public GridFSBucket getGridFSBucket(MongoClient mongoClient){
        MongoDatabase database = mongoClient.getDatabase(db);
        GridFSBucket bucket = GridFSBuckets.create(database);
        return bucket;
    }
}
```

测试代码如下:

```
@SpringBootTest
@RunWith(SpringRunner.class)
public class GridFsTest {

    @Autowired
    GridFsTemplate gridFsTemplate;

    @Autowired
    GridFSBucket gridFSBucket;

    //存文件
    @Test
    public void testStore() throws FileNotFoundException {
        //要存储的文件
        File file = new File("e:/index_banner.ftl");
        //定义输入流
        FileInputStream fileInputStream = new FileInputStream(file);
        //向GridFS存储文件
        ObjectId objectId = gridFsTemplate.store(fileInputStream, "index_banner.ftl");
        //得到文件ID
        System.out.println(objectId);
    }

    @Test
    public void queryFile() throws IOException {
        String fileId = "5d94cf4c26e4ae0c3c8dbb17";
        //根据id查询文件
        GridFSFile gridFSFile = gridFsTemplate.findOne(Query.query(Criteria.where("_id").is(fileId)));
        //打开下载流对象
        GridFSDownloadStream gridFSDownloadStream = gridFSBucket.openDownloadStream(gridFSFile.getObjectId());
        //创建gridFsResource，用于获取流对象
        GridFsResource gridFsResource = new GridFsResource(gridFSFile, gridFSDownloadStream);
        //获取流中的数据
        String s = IOUtils.toString(gridFsResource.getInputStream(), "UTF-8");
        System.out.println(s);
    }
}
```

#### 4.删除文件

```
    //删除文件
    @Test
    public void testDelFile() throws IOException {
    //根据文件id删除fs.files和fs.chunks中的记录 
    gridFsTemplate.delete(Query.query(Criteria.where("_id").is("5d94cf4c26e4ae0c3c8dbb17")));
    }
```

#### 5.手动存储模板

##### 1.添加模板

1)使用GridFS测试代码存储模板文件到GridFS，并得到文件id

2)向cms_template添加记录

![1570036503746](C:\Users\85896\AppData\Roaming\Typora\typora-user-images\1570036503746.png)

##### 2.删除模板 

1)使用GridFS测试代码根据文件id删除模板文件。

2)根据模板id删除cms_template中的记录。

##### 3.修改模板

使用Studio 3T修改cms_template中的记录。

##### 4.修改模板文件

通过Studio 3T修改模板文件(此方法限文件小于256K) 

先得到objectId

通过Studio 3T修改模板文件，先找到模板文件，再导入进去

![1570036705712](C:\Users\85896\AppData\Roaming\Typora\typora-user-images\1570036705712.png)

### 5.静态化测试

上边章节完成了数据模型和模板管理的测试，下边测试整个页面静态化的流程，流程如下：
1、填写页面DataUrl
在编辑cms页面信息界面填写DataUrl，将此字段保存到cms_page集合中。
2、静态化程序获取页面的DataUrl
3、静态化程序远程请求DataUrl获取数据模型。
4、静态化程序获取页面的模板信息
5、执行页面静态化

#### 1.填写页面DataUrl

修改页面管理模板代码，实现编辑页面DataUrl。 
注意：此地址由程序员提供给系统管理员，由系统管理员录入到系统中。 



下边实现页面修改界面录入DataUrl： 
1) 修改页面管理前端的page_edit.vue

​	 在表单中添加dataUrl输入框：

```
      <el-form-item label="数据Url" prop="dataUrl">
        <el-input v-model="pageForm.dataUrl" auto-complete="off" ></el-input>
      </el-form-item>
```

2) 修改页面管理服务端PageService

在PageService类update方法中添加：

```
//更新dataUrl
one.setDataUrl(cmsPage.getDataUrl());
```

#### 2.静态化程序

##### 1.先创建CmsTemplateRepository

```
public interface CmsTemplateRepository extends MongoRepository<CmsTemplate,String> {
}
```

##### 2.在CmsCode中添加状态码

```
CMS_PAGE_NOTEXISTS(false,24006,"页面不存在"),
```

##### 3.在PageService中定义页面静态化方法，如下：

```
    //页面静态化方法
    /**
     * 静态化程序获取页面的DataUrl
     *
     * 静态化程序远程请求DataUrl获取数据模型。
     *
     * 静态化程序获取页面的模板信息
     *
     * 执行页面静态化
     */
    public String getPageHtml(String pageId){

        //获取数据模型
        Map model = getModelByPageId(pageId);
        if(model == null){
            //数据模型获取不到
            ExceptionCast.cast(CmsCode.CMS_GENERATEHTML_DATAISNULL);
        }

        //获取页面的模板信息
        String template = getTemplateByPageId(pageId);
        if(StringUtils.isEmpty(template)){
            ExceptionCast.cast(CmsCode.CMS_GENERATEHTML_TEMPLATEISNULL);
        }

        //执行静态化
        String html = generateHtml(template, model);
        return html;

    }
    //执行静态化
    private String generateHtml(String templateContent,Map model ){
        //创建配置对象
        Configuration configuration = new Configuration(Configuration.getVersion());
        //创建模板加载器
        StringTemplateLoader stringTemplateLoader = new StringTemplateLoader();
        stringTemplateLoader.putTemplate("template",templateContent);
        //向configuration配置模板加载器
        configuration.setTemplateLoader(stringTemplateLoader);
        //获取模板
        try {
            Template template = configuration.getTemplate("template");
            //调用api进行静态化
            String content = FreeMarkerTemplateUtils.processTemplateIntoString(template, model);
            return content;
        } catch (Exception e) {
            e.printStackTrace();
        }

        return null;
    }

    //获取页面的模板信息
    private String getTemplateByPageId(String pageId){
        //取出页面的信息
        CmsPage cmsPage = this.getById(pageId);
        if(cmsPage == null){
            //页面不存在
            ExceptionCast.cast(CmsCode.CMS_PAGE_NOTEXISTS);
        }
        //获取页面的模板id
        String templateId = cmsPage.getTemplateId();
        if(StringUtils.isEmpty(templateId)){
            ExceptionCast.cast(CmsCode.CMS_GENERATEHTML_TEMPLATEISNULL);
        }
        //查询模板信息
        Optional<CmsTemplate> optional = cmsTemplateRepository.findById(templateId);
        if(optional.isPresent()){
            CmsTemplate cmsTemplate = optional.get();
            //获取模板文件id
            String templateFileId = cmsTemplate.getTemplateFileId();
            //从GridFS中取模板文件内容
            //根据文件id查询文件
            GridFSFile gridFSFile = gridFsTemplate.findOne(Query.query(Criteria.where("_id").is(templateFileId)));

            //打开一个下载流对象
            GridFSDownloadStream gridFSDownloadStream = gridFSBucket.openDownloadStream(gridFSFile.getObjectId());
            //创建GridFsResource对象，获取流
            GridFsResource gridFsResource = new GridFsResource(gridFSFile,gridFSDownloadStream);
            //从流中取数据
            try {
                String content = IOUtils.toString(gridFsResource.getInputStream(), "utf-8");
                return content;
            } catch (IOException e) {
                e.printStackTrace();
            }
        }

        return null;

    }

    //获取数据模型
    private Map getModelByPageId(String pageId){
        //取出页面的信息
        CmsPage cmsPage = this.getById(pageId);
        if(cmsPage == null){
            //页面不存在
            ExceptionCast.cast(CmsCode.CMS_PAGE_NOTEXISTS);
        }
        //取出页面的dataUrl
        String dataUrl = cmsPage.getDataUrl();
        if(StringUtils.isEmpty(dataUrl)){
            //页面dataUrl为空
            ExceptionCast.cast(CmsCode.CMS_GENERATEHTML_DATAURLISNULL);
        }
        //通过restTemplate请求dataUrl获取数据
        ResponseEntity<Map> forEntity = restTemplate.getForEntity(dataUrl, Map.class);
        Map body = forEntity.getBody();
        return body;
    }
```

##### 4.创建PageServiceTest

```
@SpringBootTest
@RunWith(SpringRunner.class)
public class PageServiceTest {

    @Autowired
    PageService pageService;

    @Test
    public void testGetPageHtml(){
    	//参数为cms_page的主键5d8f821726e4ae3a14a1ea29
    	//1.通过主键找到dataUrl 获得数据模型
    	//2.通过templateId找到cms_template
    	//3.通过cms_template的主键找到templateFileId
    	//4.templateFileId是我们通过GridFsTest提前录入的
    	//5.在fs.files通过_id可以找到我们提前导入的模板
    	//6.在fs.chunks通过files_id可以找到我们提前放入的模板
    	//7.通过generateHtml将模板和数据放在一起生成html
        String pageHtml = pageService.getPageHtml("5b9b5c2fb6eb080aa0b28e56");
        System.out.println(pageHtml);

    }

}
```

### 6.页面预览

页面在发布前增加页面预览的步骤，方便用户检查页面内容是否正确。页面预览的流程如下：

![1570070091213](C:\Users\85896\AppData\Roaming\Typora\typora-user-images\1570070091213.png)

- 用户进入cms前端，点击“页面预览”在浏览器请求cms页面预览链接。
- cms根据页面id查询DataUrl并远程请求DataUrl获取数据模型。
- cms根据页面id查询页面模板内容。
- cms执行页面静态化。
- cms将静态化内容响应给浏览器。 
- 在浏览器展示页面内容，实现页面预览的功能。

#### 1.导入依赖

```
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-freemarker</artifactId>
        </dependency>
```

#### 2.在application.yml配置freemarker

```
spring:
  freemarker:
    cache: false  #关闭模板缓存，方便测试
    settings:
      template_update_delay: 0 #不缓存页面0秒刷新
```

#### 3.PageService

之前已经实现

#### 4.controller

调用service的静态化方法，将静态化内容通过response输出到浏览器显示 
创建CmsPagePreviewController类，用于页面预览： 
请求页面id，查询得到页面的模板信息、数据模型url，根据模板和数据生成静态化内容，并输出到浏览器。

```
@Controller
public class CmsPagePreviewController extends BaseController {
    @Autowired
    PageService pageService;

    //接收到页面id
    @RequestMapping(value="/cms/preview/{pageId}",method = RequestMethod.GET)
        public void preview(@PathVariable("pageId")String pageId){
        String pageHtml = pageService.getPageHtml(pageId);
        if(StringUtils.isNotEmpty(pageHtml)){
            try {
                ServletOutputStream outputStream = response.getOutputStream();
                outputStream.write(pageHtml.getBytes("utf-8"));
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }
}
```

#### 5.配置Nginx代理

为了通过nginx请求静态资源（css、图片等），通过nginx代理进行页面预览。 
在www.xuecheng.com虚拟主机配置：

```
	#页面预览
	location /cms/preview/ {
             proxy_pass http://cms_server_pool/cms/preview/;
    }
```

配置cms_server_pool将请求转发到cms：

```
	#cms页面预览
	upstream cms_server_pool{
        server 127.0.0.1:31001 weight=10;
    }
	
    server{
	listen       80;
	server_name  www.xuecheng.com;
	ssi on;
	ssi_silent_errors on;
	location / {
		alias   X:/workspace/java/xczx/xczx01/xc-ui-pc-static-portal/;
		index  index.html;
	}
	#页面预览
	location /cms/preview/ {
             proxy_pass http://cms_server_pool/cms/preview/;
    }
	
```

#### 6.测试

重新加载nginx 配置文件。 

从cms_page找一个页面进行测试。

```
http://www.xuecheng.com/cms/preview/5d8f821726e4ae3a14a1ea29
```

5d8f821726e4ae3a14a1ea29是cms_page的主键id

#### 7.添加“页面预览”链接

在页面列表添加“页面预览”链接，修改page_list.vue:

```
          <el-button
            size="small"type="text"
            @click="edit(page.row.pageId)">编辑
          </el-button>
          <el-button
            size="small"type="text"
            @click="del(page.row.pageId)">删除
          </el-button>
          <el-button
            size="small"type="text"
            @click="preview(page.row.pageId)">页面预览
          </el-button>
```

添加preview方法：

```
      //页面预览
      preview(pageId){
        window.open("http://www.xuecheng.com/cms/preview/"+pageId)
      },
```

